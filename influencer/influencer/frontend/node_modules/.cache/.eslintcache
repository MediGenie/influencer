[{"/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/index.js":"1","/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/App.js":"2","/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/components/ChatComponent.js":"3"},{"size":182,"mtime":1699281014000,"results":"4","hashOfConfig":"5"},{"size":214,"mtime":1699281014000,"results":"6","hashOfConfig":"5"},{"size":8752,"mtime":1699546146273,"results":"7","hashOfConfig":"5"},{"filePath":"8","messages":"9","suppressedMessages":"10","errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"11"},"119b900",{"filePath":"12","messages":"13","suppressedMessages":"14","errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"11"},{"filePath":"15","messages":"16","suppressedMessages":"17","errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"18"},"/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/index.js",[],[],["19"],"/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/App.js",[],[],"/Users/kjyoo/Downloads/FOODIL/influencer/influencer/influencer/frontend/src/components/ChatComponent.js",["20","21","22"],[],"import React, { useState, useEffect, useRef } from 'react';\nimport './ChatComponent.css'; // Assume you have a CSS file for styles\nimport { io } from 'socket.io-client';\n\nconst ChatComponent = () => {\n  const [userInput, setUserInput] = useState('');\n  const [disableSend, setDisableSend] = useState(false);\n  const [selectedVoice, setSelectedVoice] = useState('');\n  const [selectedLanguage, setSelectedLanguage] = useState('');\n  const [chatMessages, setChatMessages] = useState([]);\n  const [voices, setVoices] = useState([]);\n  const [languages, setLanguages] = useState([]);\n  const [msgId, setMsgId] = useState(0);\n  const audioPlayerRef = useRef(null);\n  const voiceRef = useRef(null);\n  const [userName, setUserName] = useState('User');\n  const [audioQueue, setAudiQueue] = useState([])\n  audioPlayerRef.current = new Audio()\n\n  const ref = useRef(null);\n  ref.current = msgId;\n\n  useEffect(() => {\n    setAudiQueue([])\n    fetchData();\n\n    const socket = io('http://127.0.0.1:5001', {\n      path: '/chat-ws',\n      transports: ['websocket'],\n      autoConnect: true,\n    });\n    socket.on('connect', () => {\n      console.log('connected');\n    });\n    socket.on('error', error => {\n      console.log('error', error);\n    });\n    socket.on(`${userName}`, handleIncomingMessage);\n\n    return () => {\n      socket.off(`${userName}`, handleIncomingMessage);\n      socket.disconnect();\n    };\n  }, []);\n\n  const fetchData = async () => {\n    try {\n      console.log('Fetching config data from server...');\n      const response = await fetch('http://127.0.0.1:5001/config');\n      if (response.ok) {\n        const data = await response.json();\n        const voiceEntries = Object.entries(data.voices).map(([label, value]) => ({ label, value }));\n        const languageEntries = Object.entries(data.languages).map(([label, value]) => ({ label, value }));\n\n        setVoices(voiceEntries);\n        setLanguages(languageEntries);\n\n        // Set default selected values\n        if (voiceEntries.length > 0) {\n          setSelectedVoice(voiceEntries[0].value);\n          voiceRef.current = voiceEntries[0].value;\n        }\n        if (languageEntries.length > 0) {\n          setSelectedLanguage(languageEntries[0].value);\n        }\n      } else {\n        console.error('Failed to fetch data from the server:', response.statusText);\n      }\n    } catch (error) {\n      console.error('An error occurred while fetching data:', error);\n    }\n  };\n\n  const handleIncomingAudio = async (data) => {\n      if (data) {\n        setAudiQueue((prevAudioQueue) => {\n          // Create a new copy of the array with the updated data\n          const updatedItems = [...prevAudioQueue, data];\n          return updatedItems;\n        });\n      }\n  }\n\n  const [isPlaying, setIsPlaying] = useState(false);\n\n  useEffect(() => {\n    if (!isPlaying && audioQueue.length > 0) {\n      const nextAudio = audioQueue[0];\n      playAudio(nextAudio.audioData); // Only play audio, do not set text here\n      setAudiQueue(prevQueue => prevQueue.slice(1)); // Remove the played audio from the queue\n    }\n  }, [audioQueue, isPlaying]);\n\n  const playAudio = (base64Data) => {\n    setIsPlaying(true);\n\n    // Play the audio\n    const audio = new Audio('data:audio/mpeg;base64,' + base64Data);\n    audio.onended = () => setIsPlaying(false);\n    audioPlayerRef.current = audio;\n    audioPlayerRef.current.play();\n  };\n\n\n  const chatContainerRef = useRef(null);\n\n  useEffect(() => {\n    // Scroll to the bottom of the chat container whenever chatMessages change\n    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;\n  }, [chatMessages]);\n\n\n  useEffect(() => {\n    console.log('Voices:', voices);\n    console.log('Languages:', languages);\n  }, [voices, languages]);\n\n  const sendMessage = async () => {\n    if (!userInput.trim()) {\n      console.log('No input to send');\n      return;\n    }\n    setDisableSend(true);\n    setMsgId(prev => prev + 1);\n\n    try {\n      // Combine user input with language code if necessary\n      // For example, 'en:Hello' if English is selected.\n      const combinedInput = `${selectedLanguage}:${userInput}`;\n      setChatMessages(previousMessages =>\n        previousMessages.concat({ type: 'user', name: userName, text: userInput })\n      );\n      setUserInput('');\n      const shouldStream = true;\n      // Prepare the request body by including the combined input\n      const requestBody = {\n        user_input: combinedInput,\n        selected_voice: selectedVoice,\n        selected_language: selectedLanguage, // You might not need to send this separately now\n        userName: userName, // we send this for socket connection\n        stream: shouldStream,\n      };\n\n      const response = await fetch('http://127.0.0.1:5001/chat', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(requestBody),\n      });\n      setDisableSend(false);\n\n      if (response.ok) {\n        const responseData = await response.json();\n        console.log('Response data from POST /chat:', responseData);\n        console.log('stream finished.');\n        if (!shouldStream) {\n          setChatMessages(prevMessages => [\n            { type: 'user', name: userName, text: userInput },\n            { type: 'bot', text: responseData.text },\n          ]);\n        }\n      } else {\n        console.error('Failed to send message to the server:', response.statusText);\n      }\n    } catch (error) {\n      setDisableSend(false);\n      console.error('An error occurred:', error);\n    }\n\n    // Clear the user input after sending the message\n    setUserInput('');\n  };\n\n  const handleIncomingMessage = (data) => {\n    console.log('Incoming message data:', data);\n    // If there's audio data, add it to the audioQueue state\n    if (data.audio) {\n      setAudiQueue(prevAudioQueue => [...prevAudioQueue, { audioData: data.audio }]);\n    }\n\n    console.log('handleIncomingMessage::' + JSON.stringify(data));\n\n    setChatMessages((prevMessages) => {\n      console.log('Previous messages:', prevMessages);\n      // Find if the incoming message is a continuation of the last bot message\n      const lastMessage = prevMessages[prevMessages.length - 1];\n      let updatedMessages = prevMessages.slice(); // Create a copy of the previous messages\n\n      if (lastMessage && lastMessage.type === 'bot' && lastMessage._id === data._id) {\n          // Update the last bot message text\n          lastMessage.text += data.text;\n          console.log(chatMessages);\n          // Update the copy of the messages with the modified last message\n          updatedMessages[prevMessages.length - 1] = lastMessage;\n      } else {\n          // Add a new bot message\n          console.log('Updated messages:', prevMessages);\n          // Add the new message to the copy of messages\n          updatedMessages.push(data);\n      }\n\n      return updatedMessages; // Return the copy of the messages with the applied changes\n  });\n};\n\n\n  const handleLanguageChange = (e) => {\n    console.log('Language selected:', e.target.value);\n    setSelectedLanguage(e.target.value);\n  };\n\n  useEffect(() => {\n    console.log('Selected language state updated to:', selectedLanguage);\n  }, [selectedLanguage]);\n\n  return (\n    <div className=\"chat-container\">\n      <div className=\"chat-config\">\n        <select id=\"voices\" value={selectedVoice} onChange={(e) => setSelectedVoice(e.target.value)}>\n          {voices.map((voice, index) => (\n            <option key={index} value={voice.value}>\n              {voice.label}\n            </option>\n          ))}\n        </select>\n        <select id=\"languages\" value={selectedLanguage} onChange={handleLanguageChange}>\n  {languages.map((language, index) => (\n    <option key={index} value={language.value}>\n      {language.label}\n    </option>\n  ))}\n</select>\n      </div>\n      <div className=\"chat-messages\" ref={chatContainerRef}>\n        {chatMessages.map((msg, index) => (\n          msg.text && (\n            <div key={index} className={`message ${msg.type}`}>\n              <span className=\"message-name\">{msg.type === 'user' ? userName : 'Bot'}</span>\n              <span className=\"message-text\">{msg.text}</span>\n            </div>\n          )\n        ))}\n      </div>\n      <div className=\"chat-input\">\n      <textarea\n  value={userInput}\n  onChange={(e) => setUserInput(e.target.value)}\n  onKeyDown={(e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      if (!disableSend) {\n        sendMessage();\n      }\n    }\n  }}\n  disabled={disableSend}\n  placeholder=\"Type your message here...\"\n/>\n<button onClick={sendMessage} disabled={!userInput.trim() || disableSend}>\n  Send\n</button>\n      </div>\n    </div>\n  );\n};\n\nexport default ChatComponent;",{"ruleId":"23","replacedBy":"24"},{"ruleId":"25","severity":1,"message":"26","line":16,"column":20,"nodeType":"27","messageId":"28","endLine":16,"endColumn":31},{"ruleId":"29","severity":1,"message":"30","line":44,"column":6,"nodeType":"31","endLine":44,"endColumn":8,"suggestions":"32"},{"ruleId":"25","severity":1,"message":"33","line":74,"column":9,"nodeType":"27","messageId":"28","endLine":74,"endColumn":28},"no-new-object",["34"],"no-unused-vars","'setUserName' is assigned a value but never used.","Identifier","unusedVar","react-hooks/exhaustive-deps","React Hook useEffect has missing dependencies: 'handleIncomingMessage' and 'userName'. Either include them or remove the dependency array.","ArrayExpression",["35"],"'handleIncomingAudio' is assigned a value but never used.","no-object-constructor",{"desc":"36","fix":"37"},"Update the dependencies array to be: [handleIncomingMessage, userName]",{"range":"38","text":"39"},[1403,1405],"[handleIncomingMessage, userName]"]